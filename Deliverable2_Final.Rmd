---
title: "Appendix"
author: 
date: 
output:
  word_document:
    toc: yes
    toc_depth: 2
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
subtitle: Kogod School of Business
---

```{r global_options}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

## Read Data In

```{r}
library(tidyverse)
MxMH <- read_csv("mxmh_survey_results.csv")
```

## Check for Missing Values and Drop NA's

```{r}
colSums(is.na(MxMH))
MxMH <- subset(MxMH,select=-c(BPM))
MxMH <- drop_na(MxMH)
```


## Visual Inspection of Response Variable, Anxiety Level on scale of 0 to 10

```{r}
par(mfrow=c(1,2))

hist(MxMH$Anxiety,main="Anxiety Histogram",xlab="Anxiety")

qqnorm(MxMH$Anxiety,main="Anxiety QQ Plot")
qqline(MxMH$Anxiety)

par(mfrow=c(1,1))
```

## Transformations to Variables

```{r}
MxMH <- MxMH %>%
    mutate(`Primary streaming service`=as.factor(`Primary streaming service`)) %>%
    mutate(`While working`=as.factor(`While working`)) %>%
    mutate(Instrumentalist=as.factor(Instrumentalist)) %>%
    mutate(Composer=as.factor(Composer)) %>%
    mutate(`Fav genre`=as.factor(`Fav genre`)) %>%
    mutate(Exploratory=as.factor(Exploratory)) %>%
    mutate(`Foreign languages`=as.factor(`Foreign languages`)) %>%
    mutate(`Music effects`=as.factor(`Music effects`))
```

## Count of Different Genres from Favorite Genre Predictor

```{r}
MxMH %>%
    group_by(`Fav genre`) %>%
    count() %>%
    arrange(desc(n))
```

## Quantitative Analysis of Hours Per Day

```{r}
library(psych)
describe(MxMH)[4,1:9]

par(mfrow=c(1,2))

hist(MxMH$`Hours per day`,main="Hours per Day Histogram",xlab="Hours per Day")

qqnorm(MxMH$`Hours per day`,main="Hours per Day QQ Plot")
qqline(MxMH$`Hours per day`)

par(mfrow=c(1,1))
```

## Correlation Analysis for Quantitative/Binary Predictors:

```{r}
MxMH_1 <- MxMH %>%
    mutate(`While working`=as.numeric(`While working`)) %>%
    mutate(Instrumentalist=as.numeric(Instrumentalist)) %>%
    mutate(Composer=as.numeric(Composer)) %>%
    mutate(Exploratory=as.numeric(Exploratory)) %>%
    mutate(`Foreign languages`=as.numeric(`Foreign languages`))
selected_columns <- c("Age", "Hours per day","While working","Instrumentalist","Composer","Exploratory","Foreign languages","Anxiety")
subset_data <- MxMH_1[, selected_columns]
MxMH.cor <- cor(subset_data)
library(corrplot)
corrplot(MxMH.cor,order='hclust',method='number')
corrplot(MxMH.cor,order='hclust',method='ellipse')
```

## Boxplots of Categorical Predictors and Response Variable, Anxiety

```{r}
library(ggplot2)
par(mfrow=c(1,2))

ggplot(MxMH, aes(x=`Primary streaming service`, y=Anxiety)) + 
  geom_boxplot() +
    theme(legend.position="none") +
    coord_flip() 

ggplot(MxMH, aes(x=`Fav genre`, y=Anxiety)) + 
  geom_boxplot() +
    theme(legend.position="none") +
    coord_flip()

par(mfrow=c(1,1))
```

## ANOVA test between Categorical Predictors and Response Variable, Anxiety

```{r}
aov.streaming <- aov(Anxiety ~ `Primary streaming service`,data=MxMH)
aov.genre <- aov(Anxiety ~ `Fav genre`,data=MxMH)

summary(aov.streaming)

summary(aov.genre)
```

## Run OLS Model with initial set of predictors

```{r}
# Change reference level for primary streaming service
MxMH$`Primary streaming service`<- relevel(MxMH$`Primary streaming service`,ref="I do not use a streaming service.")

fit.ols <- lm(Anxiety ~ Age + `Primary streaming service` + `Hours per day` +
                  `While working` + Instrumentalist + Composer +`Fav genre` + 
                  Exploratory + `Foreign languages`, data =MxMH)
summary(fit.ols)
```

## Testing for OLS Assumption: Errors are Normally Distributed (EN)

```{r}
# Testing Residuals
fit.ols <- lm(Anxiety ~ Age + `Primary streaming service` + `Hours per day` +
                  `While working` + Instrumentalist + Composer +`Fav genre` + 
                  Exploratory + `Foreign languages`, data = MxMH)
hist(fit.ols$residuals)
plot(fit.ols,which=2)
```

## Testing for OLS Assumption: X's are Independent (XI)

```{r}
library(klaR)
library(car)
ci <- cond.index(fit.ols, data = MxMH)
ci
ci[length(ci)]
vif(fit.ols)
```

## Testing for OLS Assumption: Linearity (LI)

```{r}
plot(MxMH$Age,MxMH$Anxiety)
abline(lm(Anxiety ~ Age, data =MxMH), col = "red")

plot(MxMH$`Hours per day`,MxMH$Anxiety)
abline(lm(Anxiety ~ `Hours per day`, data=MxMH), col = "red")

```

## Testing for OLS Assumption: Average Error of Residuals (EA)

```{r}
mean(fit.ols$residuals)
```

## Testing for OLS Assumption: Error Variance is Constant (EV)

```{r}
plot(fit.ols,which=1)
library(lmtest)
bptest(fit.ols)
```

## Interaction Model
Interaction between age and hours per day,interaction between explanatory and while working as added predictors
```{r}
Anxiety_Model_Interaction <- lm(Anxiety ~ Age + Age*`While working` + `Primary streaming service` + `Hours per day` +`Hours per day`*Exploratory+`While working` + Instrumentalist + Composer +`Fav genre` + Exploratory + `Foreign languages`, data = MxMH)
summary(Anxiety_Model_Interaction)
```

## Testing for OLS Assumption: Errors are Normally Distributed (EN) on Interaction Model
```{r}
hist(Anxiety_Model_Interaction$residuals)
plot(Anxiety_Model_Interaction,which=2)
```

## Testing for OLS Assumption: X's are Independent (XI) on Interaction Model

```{r}
library(klaR)
library(car)
ci <- cond.index(Anxiety_Model_Interaction, data = MxMH)
ci
ci[length(ci)]
vif(Anxiety_Model_Interaction)

```


## Testing for OLS Assumption: Average Error of Residuals (EA) on Interaction Model

```{r}
mean(Anxiety_Model_Interaction$residuals)
```

## Testing for OLS Assumption: Error Variance is Constant (EV) on Interaction Model

```{r}
plot(Anxiety_Model_Interaction,which=1)
library(lmtest)
bptest(Anxiety_Model_Interaction)
```


## For simplicity just put the ols again here as well
## OLS 1st Specification 

```{r}

fit.ols <- lm(Anxiety ~ Age + `Primary streaming service` + `Hours per day` +
                  `While working` + Instrumentalist + Composer +`Fav genre` + 
                  Exploratory + `Foreign languages`, data =MxMH)
summary(fit.ols)
```

## OLS interaction specification 
## Interaction Model
Interaction between age and hours per day,interaction between explanatory and while working as added predictors
```{r}
Anxiety_Model_Interaction <- lm(Anxiety ~ Age + Age*`While working` + `Primary streaming service` + `Hours per day` +`Hours per day`*Exploratory+`While working` + Instrumentalist + Composer +`Fav genre` + Exploratory + `Foreign languages`, data = MxMH)
summary(Anxiety_Model_Interaction)
```

## Lasso 1st specification

```{r}
library(glmnet)
x <- model.matrix(Anxiety ~ Age + `Primary streaming service` + `Hours per day` + `While working` + Instrumentalist + Composer +`Fav genre` +  Exploratory + `Foreign languages`, data =MxMH)[ , -1]
y <- MxMH$Anxiety
lasso.logit <- glmnet(x, y, alpha = 1)
plot(lasso.logit)
set.seed(1)
lasso.logit.cv10 <- cv.glmnet(x, y, alpha = 1)
cbind("Lambda" = lasso.logit.cv10$lambda, "10FCV" = lasso.logit.cv10$cvm)
plot(lasso.logit.cv10)
lasso.best.lambda <- lasso.logit.cv10$lambda.min
min.cv.lasso <- min(lasso.logit.cv10$cvm)
cbind("Best Lambda" = lasso.best.lambda, "Best Log Lambda" = log(lasso.best.lambda), "Best 10FCV" = min.cv.lasso)
lasso.coef <- coef(lasso.logit, s = lasso.best.lambda)
lasso.coef.0 <- coef(lasso.logit, s = 0)
all.coefs <- round(cbind(lasso.coef, exp(lasso.coef), lasso.coef.0, exp(lasso.coef.0)), digits = 3)
colnames(all.coefs) <- c("Best LASSO", "Odds", "0-Lambda LASSO", "0dds")
all.coefs
```

## Lasso 2nd specification with interaction 

```{r}
x1 <- model.matrix(Anxiety ~ Age + Age*`While working` + `Primary streaming service` + `Hours per day` +`Hours per day`*Exploratory+`While working` + Instrumentalist + Composer +`Fav genre` + Exploratory + `Foreign languages`, data = MxMH)[ , -1]
y1 <- MxMH$Anxiety
lasso.logit1 <- glmnet(x1, y1, alpha = 1)
plot(lasso.logit1)
set.seed(1)
lasso.logit.cv101 <- cv.glmnet(x1, y1, alpha = 1)
cbind("Lambda" = lasso.logit.cv101$lambda, "10FCV" = lasso.logit.cv101$cvm)
plot(lasso.logit.cv101)
lasso.best.lambda1 <- lasso.logit.cv101$lambda.min
min.cv.lasso1 <- min(lasso.logit.cv101$cvm)
cbind("Best Lambda" = lasso.best.lambda1, "Best Log Lambda" = log(lasso.best.lambda1), "Best 10FCV" = min.cv.lasso1)
lasso.coef1 <- coef(lasso.logit1, s = lasso.best.lambda1)
lasso.coef.01 <- coef(lasso.logit1, s = 0)
all.coefs1 <- round(cbind(lasso.coef1, exp(lasso.coef1), lasso.coef.01, exp(lasso.coef.01)), digits = 3)
colnames(all.coefs1) <- c("Best LASSO", "Odds", "0-Lambda LASSO", "0dds")
all.coefs1
```

## Boosted Trees 1st specification

```{r}
library(gbm) # Generalized Boosted Regression Models
set.seed(1) # To get replicable results
MxMH.boost <- gbm(Anxiety ~ Age + `Primary streaming service` + `Hours per day` + `While working` + Instrumentalist + Composer +`Fav genre` +  Exploratory + `Foreign languages`, data =MxMH,
distribution = "gaussian",
shrinkage = 0.01,
cv.folds = 10,
n.trees = 5000,
interaction.depth = 1)

MxMH.boost

summary(MxMH.boost)

best.num.trees <- which.min(MxMH.boost$cv.error)
# Smallest CV Test Error
min.mse.boost <- round(min(MxMH.boost$cv.error), digits = 3)
min.rmse.boost <- round(sqrt(min.mse.boost), digits = 3)
# Display result
paste("Min 10FCV Test MSE =", min.mse.boost, "Test RMSE =", min.rmse.boost, "at", best.num.trees, "trees")
```


## Boosted tree with interaction specification

```{r}
set.seed(1) # To get replicable results
MxMH.boost1 <- gbm(Anxiety ~ Age + Age*`While working` + `Primary streaming service` + `Hours per day` +`Hours per day`*Exploratory+`While working` + Instrumentalist + Composer +`Fav genre` + Exploratory + `Foreign languages`, data = MxMH,
distribution = "gaussian",
shrinkage = 0.01,
cv.folds = 10,
n.trees = 5000,
interaction.depth = 1)

MxMH.boost1

summary(MxMH.boost1)

best.num.trees1 <- which.min(MxMH.boost1$cv.error)
# Smallest CV Test Error
min.mse.boost1 <- round(min(MxMH.boost1$cv.error), digits = 3)
min.rmse.boost1 <- round(sqrt(min.mse.boost1), digits = 3)
# Display result
paste("Min 10FCV Test MSE =", min.mse.boost1, "Test RMSE =", min.rmse.boost1, "at", best.num.trees1, "trees")

```




















































